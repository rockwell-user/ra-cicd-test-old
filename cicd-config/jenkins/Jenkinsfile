pipeline {
    agent any
    
    environment {
        //PATH_JENKINS_GITHUB = 'C:\\Users\\ASYost\\source\\repos\\ra-cicd-test-old\\'
        PATH_JENKINS_GITHUB = 'C:\\data\\jenkins_home\\workspace\\RA-CICD-Pipeline\\'
        ACDFILENAME = 'CICD_test.ACD'
        GITHUB_USER_EMAIL = 'andresyost2000@gmail.com'
        GITHUB_USER_NAME = 'Andre Sandor Yost'
        GITHUB_USERNAME = 'rockwell-user'
        GITHUB_PASSWORD = 'RockwellGithub!'
        GITHUB_ACCESTOKEN = 'ghp_mpOj91xiccmZmGnGezvyxYLNWNas8Z39k?z?E?P?'
        GITHUB_REPO_NAME = 'ra-cicd-test-old'
        GITHUB_DEV_BRANCH = 'dev-branch'
        DOTNET_VERSION = '8.0'
        DOTNET_INSTALL_DIR = 'C:\\Program Files\\dotnet'
        TEST_RESULT = ''
        UNIQUE_LABEL = "${BUILD_TAG}-${GIT_COMMIT}"
    }

    stages {
        stage('Check .NET SDK') {
            steps {
                createBanner('STAGE: Check .NET SDK')
                script {
                    def dotnetVersionInstalledCMD = bat(
                        script: 'dotnet --version',
                        returnStdout: true
                    ).trim()
                    def dotnetVersionInstalled_values = dotnetVersionInstalledCMD.split(' ')
                    def dotnetVersionInstalled = dotnetVersionInstalled_values[2].trim()

                    if (!dotnetVersionInstalled.startsWith(env.DOTNET_VERSION)) {
                        echo "Installing .NET SDK $DOTNET_VERSION..."
                        bat label: 'Install .NET SDK %DOTNET_VERSION%',
                            script: """
                                mkdir "$DOTNET_INSTALL_DIR"
                                cd "$DOTNET_INSTALL_DIR"
                                curl -o dotnet-install.ps1 -L https://dot.net/v1/dotnet-install.ps1
                                powershell -ExecutionPolicy Bypass -File .\\dotnet-install.ps1 -Channel $DOTNET_VERSION -InstallDir \"$DOTNET_INSTALL_DIR\" -NoPath
                            """
                    } else {
                        echo ".NET SDK $DOTNET_VERSION is already installed."
                    }
                }
            }
        }
        stage ('Build') {
            steps {
                createBanner('STAGE: Build')
                echo "Starting Build..."

                script {
                    def currentUser_NugetConfigXMLfile = 'C:\\Users\\ASYost\\AppData\\Roaming\\NuGet\\NuGet.Config'
                    def jenkinsUser_NugetConfigXMLfile = 'C:\\Users\\Jenkins\\AppData\\Roaming\\NuGet\\NuGet.Config'

                    //def currentUser_NugetConfigXMLfileContents = bat(script: "type ${currentUser_NugetConfigXMLfile}", returnStdout: true).trim()
                    bat """
                        type ${currentUser_NugetConfigXMLfile} > ${jenkinsUser_NugetConfigXMLfile}
                        cd %PATH_JENKINS_GITHUB%cicd-config\\TestStage_CICD
                        dotnet build --configuration Release
                    """
                    // dotnet clean ./TestStage_CICD.sln --configuration Release && dotnet nuget locals all --clear
                }
            }
        }
        stage('Test') {
            steps {
                createBanner('STAGE: Test')
                echo "Starting Test..."
                powershell(script: '''
                    cd %PATH_JENKINS_GITHUB%
                    git log -1 --pretty=format:'%an'
                    git log -1 --pretty=format:'%ae'
                ''')
                script {
                    testResult = bat(script: "@%PATH_JENKINS_GITHUB%cicd-config\\TestStage_CICD\\TestScript_ConsoleApplication\\bin\\Release\\net8.0\\TestScript_ConsoleApplication.exe %PATH_JENKINS_GITHUB% %ACDFILENAME%", returnStdout: true).trim()
                    echo "Test result is: ${testResult}"
                    displayContentsOfMostRecentTextFile("${env.PATH_JENKINS_GITHUB}test-reports\\textFiles")
                    TEST_RESULT = testResult
                }
            }
        }
        stage('Release') {
            steps {
                createBanner('STAGE: Release')
                script {
                    if (TEST_RESULT == 'SUCCESS') {
                        echo 'Test SUCCESS: Start releasing development results...'
                        def cleaned_token = env.GITHUB_ACCESTOKEN.replaceAll("\\?", "")
                        def gitUrl = "https://${env.GITHUB_USERNAME}:${cleaned_token}@github.com/${env.GITHUB_USERNAME}/${env.GITHUB_REPO_NAME}.git"
                        echo env.UNIQUE_LABEL
                        bat """
                            cd %PATH_JENKINS_GITHUB%
                            git remote set-url origin ${gitUrl}
                            git config --global --add safe.directory "*"
                            git config --global core.autocrlf false
                            git config --global user.email %GITHUB_USER_EMAIL%
                            git config --global user.name "%GITHUB_USER_NAME%"
                            git branch -a
                            git checkout %GITHUB_DEV_BRANCH%
                            git add -A
                            git commit -m "%UNIQUE_LABEL% | Commiting Results for Successful Jenkins Automated Test"
                            git push origin %GITHUB_DEV_BRANCH%

                        """
                    }
                    else {
                        echo 'Test FAILURE: Return to Studio 5000 Logix Designer, correct the error, and push a new commit.'
                        sendEmail('FAILURE')
                    }
                }
                
            }
        }
        stage('Deploy') {
            steps {
                createBanner('STAGE: Deploy')
            }
        }
        stage ('Clean Workspace') {
            steps {
                createBanner('STAGE: Clean Workspace')
                cleanWs()
            }
        }
    }
    // post {
    //     always {
    //         echo 'Cleaning up workspace...'
    //         deleteDir() /* clean up our workspace */
    //     }
    //     success {
    //         createBanner('CI/CD pipeline executed successfully!')
    //     }
    //     failure {
    //         createBanner('CI/CD pipeline failed with errors.')
    //     }
    // }
}

def createBanner(bannerName) {
    script {
        def finalBanner = '-=[' + bannerName + ']=-'
        echo finalBanner.padRight(200, '-')
    }
}

def displayContentsOfMostRecentTextFile(folderPath) {
    def fileList = bat(script: "dir /b /o:-d ${folderPath}", returnStdout: true).trim().split('\r\n')
    if (fileList.size() > 0) {
        def mostRecentFile = fileList[1]
        echo "The contents of the most recent test file (${mostRecentFile}):"
        def fileContents = readFile("${folderPath}\\${mostRecentFile}")
        echo "${fileContents}"
    } else {
        echo "No text files found in the folder: ${folderPath}"
    }
}